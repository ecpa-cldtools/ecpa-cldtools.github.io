class ClsMediaInspectorTool{#e="0.0.2";#t=[];#n=[];constructor(){this.init()}init(){console.log("CldMediaInspectorTool Version",this.#e)}addMediaSrc(e){this.#t.push(e),this.addMediaRowData(e)}getThumbnail(e){var t=`<img src=${e.MediaPerf.name} style="width:100px">`,n=parseInt(e.MediaRespHdr["content-length"])>0?t:'<img src="https://defaultplaceholder.png" width=100 height=100 />',a="<div>",i=e.MediaRespHdr["content-type"].split("/")[1],s=e.MediaRespHdr["content-type"]||"";return void 0!==s&&(s.match(/^image\//i)?a+=n:s.match(/^video\//i)?a+=`\n<video width="300" controls>\n  <source src="${e.MediaPerf.name}" type="${e.MediaRespHdr["content-type"]}">\n  Your browser does not support the video tag.\n</video>`:s.match(/javascript/i)?a+='\n<span style="display: table;margin: 0 auto;color:lightgray;font-weight:bold;width: 60px;height: 50px;text-align: center;font-family: sans-serif;border-radius: 5px 5px 5px; border: 1px solid lightgray;float:left;">{ . . . }   JS</span>':a+=`\n<span style="display: table;margin: 0 auto;color:lightgray;font-weight:bold;width: 60px;height: 50px;text-align: center;font-family: sans-serif;border-radius: 5px 5px 5px; border: 1px solid lightgray;float:left;">{ - }   ${i.toUpperCase()}</span>`),a+="</div>"}getUrl(e){var t='<div style="width: 300px;padding-left: 5px;">';return void 0!==(e.MediaRespHdr["content-type"]||"")&&(t+=`<a style="word-wrap: break-word;" href=${e.MediaPerf.name} target="_blank" >${e.MediaPerf.name}</a>`),t+="</div>"}getEntitiesCount(e){return"1","</div>",'<div style="width: 15px;padding-left: 5px;">1</div>'}getService(e){var t='<div style="width: 140px;padding-left: 5px;">';return t+='<span style="word-wrap: break-word;">',t+=null!=e.MediaRespHdr.server?e.MediaRespHdr.server:e.MediaRespHdr.hostname,t+="</span>",t+="</div>"}getResponseStatus(e){var t='<div style="width: 30px;padding-left: 5px;">';return t+=parseInt(e.MediaPerf.responseStatus)<1&&parseInt(e.MediaRespHdr["content-length"])<1?"404":(parseInt(e.MediaPerf.responseStatus)||200).toString(),t+="</div>"}getErrorMessage(e){var t='<div style="width: 150px;padding-left: 5px;">';return t+='<span style="word-wrap: break-word;">',t+=e.MediaRespHdr["error-message"],t+="</span>",t+="</div>"}getContentLength(e){var t='<div style="padding-left: 5px;">',n=parseInt(e.MediaRespHdr["content-length"])<1?"0 B":parseInt(e.MediaRespHdr["content-length"]);return t+=isNaN(n)?"0 B":n+" B",t+="</div>"}getScaleRatio(e){var t='<div style="width:90px;padding-left: 5px;">',n="No image to display";if(e.MediaRespHdr["content-type"]?.match(/image|video/))if(void 0===e.MediaDoc||0===e.MediaDoc.naturalWidth||0===e.MediaDoc.naturalHeight);else if(e.MediaRespHdr["content-type"]?.match(/image/))n=(e.MediaDoc.naturalWidth/e.MediaDoc.clientWidth).toFixed(2)+":"+(e.MediaDoc.naturalHeight/e.MediaDoc.clientHeight).toFixed(2);else if(e.MediaRespHdr["content-type"]?.match(/video/)){n=(e.MediaDoc.videoWidth/e.MediaDoc.clientWidth).toFixed(2)+":"+(e.MediaDoc.videoHeight/e.MediaDoc.clientHeight).toFixed(2)}return t+=n,t+="</div>"}getContentType(e){var t='<div style="width:70px;padding-left: 5px;">';let n="";if(""!==e.MediaRespHdr["content-type"]){var a=e.MediaRespHdr["content-type"].split("/"),i=a[0];i=i.charAt(0).toUpperCase()+i.substring(1);var s=a[1].split(";")[0];n=i+" "+("JAVASCRIPT"===(s=s.toUpperCase())?"JS":s)}return t+=n,t+="</div>"}getContentLength(e){var t='<div style="padding-left: 5px;">',n=parseInt(e.MediaRespHdr["content-length"]);if(isNaN(n))return"0 B";for(var a=0;n>=1024;)n/=1024,++a;return t+=(0==a?n:n.toFixed(2))+" "+["B","KB","MB","GB","TB","PB","EB","ZB","YB"][a],t+="</div>"}getTtfb(e){var t='<div style="padding-left: 5px;">',n=void 0===e.MediaPerf?-1:e.MediaPerf.responseStart-e.MediaPerf.requestStart;return t+=n<0?"N/A":n.toFixed(2)+" ms",t+="</div>"}getContentDlTime(e){var t='<div style="padding-left: 5px;">',n=void 0===e.MediaPerf?-1:e.MediaPerf.responseEnd-e.MediaPerf.responseStart;return t+=n<0?"N/A":n.toFixed(2)+" ms",t+="</div>"}getDetails(e,t){this.getDetailsPane(t);return'<div class="mediadetail">\n      <p>Not yet available</p>\n    </div>',"</div>",'<div style="padding-left: 5px;"><button id="viewdetail" class="collapsible">View</button><div class="mediadetail">\n      <p>Not yet available</p>\n    </div></div>'}getDetailsPane(e){return`\n      <div class="tab tab${e}">\n        <button class="tablinks tablinks${e}" onclick="openCity(${e}, event, 'London')" id="defaultOpen${e}">London</button>\n        <button class="tablinks tablinks${e}" onclick="openCity(${e}, event, 'Paris')">Paris</button>\n        <button class="tablinks tablinks${e}" onclick="openCity(${e}, event, 'Tokyo')">Tokyo</button>\n      </div>\n      <div id="London${e}" class="tabcontent tabcontent${e}">\n        <h5>London</h5>\n        <p>London is the capital city of England ${e}.</p>\n      </div>\n      <div id="Paris${e}" class="tabcontent tabcontent${e}">\n        <h5>Paris</h5>\n        <p>Paris is the capital of France ${e}.</p> \n      </div>\n      <div id="Tokyo${e}" class="tabcontent tabcontent${e}">\n        <h5>Tokyo</h5>\n        <p>Tokyo is the capital of Japan ${e}.</p>\n      </div>\n      `}addMediaRowData(e){var t=[];t.push({style:'style="font-size: 14px;"',value:(this.#n.length+1).toString()}),t.push({style:"",value:this.getThumbnail(e)}),t.push({style:'style="font-size: 14px;"',value:this.getService(e)}),t.push({style:'style="font-size: 14px;"',value:this.getResponseStatus(e)}),t.push({style:'style="font-size: 14px;"',value:this.getErrorMessage(e)}),t.push({style:'style="font-size: 14px;"',value:this.getUrl(e)}),t.push({style:'style="font-size: 14px;"',value:this.getEntitiesCount(e)}),t.push({style:'style="font-size: 14px;"',value:this.getScaleRatio(e)}),t.push({style:'style="font-size: 14px;"',value:this.getContentType(e)}),t.push({style:'style="font-size: 14px;"',value:this.getContentLength(e)}),t.push({style:'style="font-size: 14px;"',value:this.getTtfb(e)}),t.push({style:'style="font-size: 14px;"',value:this.getContentDlTime(e)}),t.push({style:'style="font-size: 14px;"',value:this.getDetails(e,this.#n.length)}),this.#n.push(t)}getTimestamp(){return(new Date).toISOString().replace(/-/g,"").replace(/:/g,"").replace(/\./,"")}createReportPage(e,t,n){const a=`<!DOCTYPE html>\n<html>\n<head>\n  <title>Cld Media Analyzer</title>\n  <meta charset="utf-8">\n  <meta name="viewport" content="width=device-width, initial-scale=1">\n  <link rel="stylesheet" type="text/css"\n      href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/css/bootstrap.css" />\n  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap4.min.css" />\n  <script src="https://code.jquery.com/jquery-3.5.1.js"><\/script>\n  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"><\/script>\n  <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap4.min.js"><\/script>\n  <style>\n    .collapsible {\n      background-color: #777;\n      color: white;\n      cursor: pointer;\n      border: none;\n      font-size: 15px;\n      width: 100%;\n    }\n\n    .active, .collapsible:hover {\n      background-color: #555;\n    }  \n\n    .collapsible:after {\n      //content: '+';\n      color: white;\n      font-weight: bold;\n      float: right;\n      margin-left: 5px;\n    }\n\n    .mediadetail {\n      padding: 0 18px;\n      max-height: 0;\n      overflow: hidden;\n      transition: max-height 0.2s ease-out;\n    }\n\n    /* ********** Style the tab */\n    .tab {\n      float: left;\n      border: 1px solid #ccc;\n      background-color: #f1f1f1;\n      width: 30%;\n      height: 300px;\n    }\n    \n    /* Style the buttons inside the tab */\n    .tab button {\n      display: block;\n      background-color: inherit;\n      color: black;\n      padding: 22px 16px;\n      width: 100%;\n      border: none;\n      outline: none;\n      text-align: left;\n      cursor: pointer;\n      transition: 0.3s;\n      font-size: 17px;\n    }\n    \n    /* Change background color of buttons on hover */\n    .tab button:hover {\n      background-color: #ddd;\n    }\n    \n    /* Create an active/current "tab button" class */\n    .tab button.active {\n      background-color: #ccc;\n    }\n    \n    /* Style the tab content */\n    .tabcontent {\n      float: left;\n      padding: 0px 12px;\n      border: 1px solid #ccc;\n      width: 70%;\n      border-left: none;\n      height: 300px;\n    }\n  </style>\n</head>\n<body>\n    <div class="mycontainer" style="padding-left: 20px;padding-right: 20px;padding-bottom: 50px;">\n      <h2>CLD Media Analyzer</h2>\n      <p>The list of images from the current page that are being analyzed.</p>  \n      <table id="example" class="table table-striped table-bordered" style="width:100%">\n          ${e}\n          ${t}\n          ${n}\n      </table>\n      <script>\n          $(document).ready(function () {\n              $('#example').DataTable();\n          });\n      <\/script>\n    </div>\n    <script>\n      var coll = document.getElementsByClassName("collapsible");\n      var i;\n      for (i = 0; i < coll.length; i++) {\n        coll[i].addEventListener("click", function() {\n          this.classList.toggle("active");\n          var content = this.nextElementSibling;\n          if (content.style.maxHeight){\n            content.style.maxHeight = null;\n          } else {\n            content.style.maxHeight = content.scrollHeight + "px";\n          } \n        });\n      }\n    <\/script>\n\n    <script>\n      function openCity(tabClsIndex, evt, cityName) {\n        var i, tabcontent, tablinks;\n        tabcontent = document.getElementsByClassName("tabcontent" + tabClsIndex.toString());\n        for (i = 0; i < tabcontent.length; i++) {\n          tabcontent[i].style.display = "none";\n        }\n        tablinks = document.getElementsByClassName("tablinks" + tabClsIndex.toString());\n        for (i = 0; i < tablinks.length; i++) {\n          tablinks[i].className = tablinks[i].className.replace(" active", "");\n        }\n        document.getElementById(cityName + tabClsIndex.toString()).style.display = "block";\n        evt.currentTarget.className += " active";\n      }\n\n      var x = 0;\n      var rowItems = document.getElementsByClassName("collapsible");\n      for(x = 0; x < rowItems.length; x++)\n      {\n        document.getElementById("defaultOpen" + x.toString()).click();\n      }\n    <\/script>          \n</body>\n</html>\n      `,i=URL.createObjectURL(new Blob([a],{type:"text/html"}));this.getTimestamp(),window.open(i,"win"+this.getTimestamp(),"width=1500,height=800,screenX=100,screenY=100")}show(){var e=new ClsMITTable;e.addHeaderFooter("Item"),e.addHeaderFooter("Thumb"),e.addHeaderFooter("Service"),e.addHeaderFooter("Status"),e.addHeaderFooter("Error"),e.addHeaderFooter("URL"),e.addHeaderFooter("#"),e.addHeaderFooter("Scale Ratio"),e.addHeaderFooter("Content Type"),e.addHeaderFooter("Size"),e.addHeaderFooter("TTFB"),e.addHeaderFooter("Content Download"),e.addHeaderFooter("Details"),this.#n.forEach((t=>{e.addRow(t)})),this.createReportPage(e.setHeader(),e.setRow(),e.setFooter())}}class ClsMediaSource{#a;#i;#s;constructor(){}set MediaPerf(e){this.#a=e}get MediaPerf(){return this.#a}set MediaDoc(e){this.#i=e}get MediaDoc(){return this.#i}set MediaRespHdr(e){this.#s=e}get MediaRespHdr(){return this.#s}}class ClsMITTable{#o=0;#r=0;#d=0;#l=0;#c=[];#p=[];#h=[];constructor(){}addRow(e){var t="<tr>\n";e.forEach((e=>{t+=`<td ${e.style}>${e.value}</td>\n`})),t+="</tr>",this.#c.push(t),this.setRow(),this.#o++}addCol(e){this.#r++}addHeaderFooter(e){this.addHeader(e),this.addFooter(e)}addHeader(e){this.#p.push(`<th>${e}</th>`),this.setHeader(),this.#d++}addHeader(e,t){this.#p.push(`<th ${t}>${e}</th>`),this.setHeader(),this.#d++}addHeader(e,t,n){this.#p.push(`<th ${n} ${t}>${e}</th>`),this.setHeader(),this.#d++}addFooter(e){this.#h.push(`<th>${e}</th>`),this.setFooter(),this.#l++}setRow(){var e="<tbody>\n";return this.#c.forEach((t=>{e+=t+"\n"})),e+="</tbody>\n"}setHeader(){var e='<thead>\n<tr role="row">\n';return this.#p.forEach((t=>{e+=t+"\n"})),e+="</tr>\n</thead>"}setFooter(){var e="<tfoot>\n<tr>\n";return this.#p.forEach((t=>{e+=t+"\n"})),e+="</tr>\n</tfoot>"}}function getResponseHeader(e){return new Promise((t=>{const n=[];var a=window.location.origin;console.log("Working origin",a),n.push(e);const i=e=>e,s=e=>e.ok?Promise.resolve(e):Promise.reject(e);Promise.all(n.map((e=>fetch(e,{headers:{"Access-Control-Allow-Origin":a,"Access-Control-Allow-Headers":a}}).then(s).then(i)))).then((e=>{t(e)})).catch((n=>{console.log("Encountered error while fetching head!",n);var a="";a=void 0===n.ok?n.toString():"Resource not found";var i=[],s=[],o={"content-type":"null/null",ok:!1,status:"404",statusText:"nok"};o.url=e,s.headers=o,n.headers=s,n.errorMessage=a,i.push(n),t(i)}))}))}function loadPerfData(){return new Promise((e=>{const t=()=>{performance.getEntriesByType("navigation")[0].duration?e("All loaded!"):setTimeout(t,10)};t()}))}async function asyncProcess(){console.log("Start asyncProcess");const e=await loadPerfData();console.log(e),console.log("Do all data gathering...");const t=new ClsMediaInspectorTool;let n=Array.from(window.document.querySelectorAll("*")),a=window.performance.getEntriesByType("resource").filter((e=>"img"==e.initiatorType||"video"==e.initiatorType)),i="";for(var s=0;s<n.length;++s){var o=n[s];if("IMG"===o.nodeName.toUpperCase()||"VIDEO"===o.nodeName.toUpperCase()){i="SCRIPT"===o.nodeName.toUpperCase()?o.src:o.currentSrc;let e=!1;var r=new ClsMediaSource;for(b=0;b<a.length;b++)i!==a[b].name||e||(e=!0,r.MediaDoc=o,r.MediaPerf=a[b]);if(!e&&""!=i){if((await getResponseHeader(i))[0].ok){let t=window.performance.getEntriesByType("resource").filter((e=>e.name==i));r.MediaDoc=o,t.length>0&&(r.MediaPerf=t[0],e=!0)}}if(e){const e=await getResponseHeader(i);var d={},l="",c="",p=!1;if(e[0].ok)for(var h of e[0].headers.entries())d[h[0]]=h[1];else{for(var h of(console.log("respHdr.Nok",e),e[0].headers.entries()))d[h[0]]=h[1],"x-cld-error"===h[0]&&(l=h[0]+": "+h[1],p=!0);p||(l=e[0].errorMessage),d["content-type"]="na/html"}try{c=new URL(i).hostname}catch(e){c="undefined"}d.hostname=c,d["error-message"]=l,r.MediaRespHdr=d,t.addMediaSrc(r)}}}t.show(),console.log("objMiTool",t)}function appMain(){console.log("Start appMain"),asyncProcess()}appMain();
